apiVersion: apps/v1
kind: Deployment
metadata:
  name: openvoting
  labels:
    app: openvoting
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  replicas: 1
  selector:
    matchLabels:
      app: openvoting
  template:
    metadata:
      labels:
        app: openvoting
        {{- if eq .Values.image.tag "latest" }}
        date: "{{ now | unixEpoch }}"
        {{- end }}
    spec:
      containers:
        - name: openvoting
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          ports:
            - containerPort: 8080
          imagePullPolicy: Always
          resources: {{ toYaml .Values.resources | nindent 12 }}
          {{- $env := .Values.env }}
          env:
            - name: ConnectionStrings__Database
              valueFrom:
                secretKeyRef:
                  name: openvoting-secrets
                  key: "db-connection-string"
            - name: Settings__Discord__ClientId
              value: {{ $env.discord.clientId | quote }}
            - name: Settings__Discord__ClientSecret
              valueFrom:
                secretKeyRef:
                  name: openvoting-secrets
                  key: "discord-client-secret"
            - name: Settings__Discord__GuildId
              value: {{ $env.discord.guildId | quote }}
            - name: Settings__Discord__BotToken
              valueFrom:
                secretKeyRef:
                  name: openvoting-secrets
                  key: "discord-bot-token"
            {{- $roles := splitList "," $env.discord.adminRoleIds }}
            {{- range $idx, $role := $roles }}
              {{- $trimmed := trim $role }}
              {{- if $trimmed }}
            - name: {{ printf "Settings__Discord__AdminRoleIds__%d" $idx | quote }}
              value: {{ $trimmed | quote }}
              {{- end }}
            {{- end }}
            - name: Settings__Jwt__SigningKey
              valueFrom:
                secretKeyRef:
                  name: openvoting-secrets
                  key: "jwt-signing-key"
            - name: Settings__BlobStorage__ConnectionString
              valueFrom:
                secretKeyRef:
                  name: openvoting-secrets
                  key: "storage-connection-string"
            - name: Settings__BlobStorage__ContainerName
              value: {{ $env.blobStorage.containerName | quote }}
            - name: Settings__BlobStorage__PublicBaseUrl
              value: {{ $env.blobStorage.publicBaseUrl | quote }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 4
            failureThreshold: 5
      imagePullSecrets: {{ toYaml .Values.imagePullSecrets }}
